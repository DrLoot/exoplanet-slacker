<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transit Post Generator | Exoplanet Slacker</title>
  <meta name="description" content="Generate formatted Slack posts for transit light curve reductions." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@700&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --bg: #05060b;
      --card: #0f1220;
      --glow: #5bc0ff;
      --accent: #FF6F00;
      --text: #EAEAEA;
      --muted: #A9B1C3;
      --radius: 16px;
      --shadow: 0 10px 40px rgba(0, 0, 0, .45);
      --border: rgba(123, 198, 255, .14);
      --link: #79c8ff;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
    }

    .starfield {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(91, 192, 255, .12), transparent 60%),
        radial-gradient(1000px 700px at 10% 120%, rgba(255, 111, 0, .08), transparent 60%),
        linear-gradient(180deg, #070910 0%, #04050a 100%);
    }

    .stars,
    .stars:before,
    .stars:after {
      content: "";
      position: absolute;
      inset: -2000px;
      background-repeat: repeat;
    }

    .stars {
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255, 255, 255, .7) 50%, transparent 51%),
        radial-gradient(1.5px 1.5px at 100px 80px, rgba(255, 255, 255, .5) 50%, transparent 51%),
        radial-gradient(1px 1px at 50px 140px, rgba(255, 255, 255, .4) 50%, transparent 51%);
      animation: drift 160s linear infinite;
      opacity: .85;
    }

    .stars:before {
      background-image:
        radial-gradient(1.5px 1.5px at 40px 60px, rgba(255, 255, 255, .35) 50%, transparent 51%),
        radial-gradient(1px 1px at 80px 120px, rgba(255, 255, 255, .25) 50%, transparent 51%);
      animation: drift 220s linear infinite;
    }

    .stars:after {
      background-image:
        radial-gradient(1px 1px at 70px 90px, rgba(123, 198, 255, .4) 50%, transparent 51%),
        radial-gradient(1px 1px at 140px 30px, rgba(255, 171, 64, .35) 50%, transparent 51%);
      animation: drift 300s linear infinite;
    }

    @keyframes drift {
      from {
        transform: translate3d(0, 0, 0)
      }

      to {
        transform: translate3d(2000px, 2000px, 0)
      }
    }

    header {
      padding: clamp(48px, 8vw, 96px) 24px 32px;
      text-align: center;
      background: radial-gradient(900px 600px at 80% 20%, rgba(91, 192, 255, .12), transparent 60%);
    }

    h1 {
      font-family: Orbitron, Inter, sans-serif;
      font-size: clamp(28px, 5.6vw, 56px);
      margin: 0;
    }

    .subtitle {
      max-width: 900px;
      margin: 12px auto 24px;
      color: var(--muted);
    }

    .nav {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid #1f2a44;
      background: linear-gradient(180deg, #133252, #0c1b2e);
      color: var(--text);
      text-decoration: none;
      box-shadow: var(--shadow);
      cursor: pointer;
    }

    .btn:hover {
      transform: translateY(-1px)
    }

    main {
      padding: 24px;
      max-width: 1100px;
      margin: 0 auto
    }

    .card {
      background: linear-gradient(180deg, rgba(16, 20, 40, .7), rgba(10, 12, 20, .8));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
      margin-bottom: 28px;
    }

    h2 {
      margin: 0 0 8px
    }

    .muted {
      color: var(--muted)
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    /* make some rows span the full grid width */
    .form-grid-row-full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 14px;
      display: block;
      margin-bottom: 3px;
      color: var(--muted);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(123, 198, 255, .2);
      background: rgba(10, 12, 20, .9);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      font-size: 13px;
    }

    .inline-options label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin: 0;
      color: var(--muted);
    }

    .inline-options input[type="checkbox"] {
      width: auto;
    }

    .template-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .template-row select {
      max-width: 220px;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(123, 198, 255, .35);
      background: rgba(15, 18, 32, .9);
      color: #9ed1ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 6px;
      margin-top: 6px;
    }

    .history-list {
      display: grid;
      gap: 12px;
      margin-top: 12px;
    }

    .history-item {
      background: rgba(15, 18, 32, .7);
      border-radius: 12px;
      border: 1px solid rgba(123, 198, 255, .18);
      padding: 10px 12px;
      font-size: 13px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .history-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .history-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .mini-btn {
      border-radius: 999px;
      border: 1px solid #1f2a44;
      background: linear-gradient(180deg, #133252, #0c1b2e);
      color: #fff;
      font-size: 11px;
      padding: 3px 9px;
      cursor: pointer;
    }

    /* ---- Flair legend (global) ---- */

    .flair-wrap {
      margin-top: 12px;
      font-size: 13px;
    }

    .flair-heading {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .flair-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 4px;
    }

    .flair-column {
      flex: 1 1 220px;
      background: rgba(8, 10, 20, 0.9);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(123, 198, 255, 0.18);
    }

    .flair-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .flair-rows {
      display: grid;
      gap: 4px;
    }

    .flair-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(123, 198, 255, 0.14);
      background: radial-gradient(circle at 0% 0%, rgba(123, 198, 255, 0.08), transparent 55%);
      color: #d6e5ff;
    }

    .flair-label {
      opacity: 0.9;
    }

    .flair-row.active {
      border-color: #ffd46a;
      background: radial-gradient(circle at 10% 0%, rgba(255, 212, 106, 0.35), transparent 60%);
      box-shadow:
        0 0 0 1px rgba(255, 212, 106, 0.6),
        0 0 16px rgba(255, 212, 106, 0.8);
      color: #fff7df;
    }

    .flair-note {
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width:600px) {
      .buttons-row {
        flex-direction: column;
        align-items: stretch;
      }

      .buttons-row .btn {
        justify-content: center;
        width: 100%;
      }

      /* optional: stack the columns vertically on very small screens */
      .flair-columns {
        flex-direction: column;
      }
    }

    dialog {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      background: linear-gradient(180deg, rgba(16, 20, 40, .96), rgba(10, 12, 20, .98));
      color: var(--text);
      max-width: 440px;
      width: calc(100% - 40px);
      box-shadow: var(--shadow);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
    }

    .info-card-grid {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      align-items: flex-start;
    }

    .info-card-grid>div {
      flex: 1 1 0;
      min-width: 0;
    }

    .info-card-grid h3 {
      margin: 0 0 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .info-card-grid ul {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
    }

    .info-card-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0 6px;
    }

    .info-card-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      white-space: nowrap;
    }

    .info-card-badge.badge-planet {
      /* subtle emphasis for planet badge */
      font-weight: 500;
    }

    .info-card-badge.badge-star {
      opacity: 0.9;
    }

    @media (max-width: 520px) {
      .info-card-grid {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="starfield" aria-hidden="true">
    <div class="stars"></div>
  </div>

  <header>
    <h1>Transit Post Generator</h1>
    <p class="subtitle">
      Build consistent Slack posts for your transit light curve reductions. Choose your format, add SNR &amp; rank
      flair, and keep a local history of your observations.
    </p>
    <nav class="nav" aria-label="Primary">
      <a class="btn" href="index.html">‚Üê Back to Home</a>
    </nav>
  </header>

  <main>
    <!-- Builder -->
    <section class="card" aria-labelledby="builder-heading">
      <h2 id="builder-heading">1. Observation Details</h2>
      <p class="muted">Upload your AAVSO.txt file from EXOTIC, or fill in the transit info manually. You can either
        enter SNR directly or
        compute it from Rp¬≤/Rs¬≤ and its uncertainty.</p>

      <form id="transitForm" autocomplete="off">
        <div class="form-grid">
          <div class="form-grid-row-full">
            <br>
            <label class="btn" style="padding:6px 12px; font-size:12px; cursor:pointer; margin-top:6px;">
              Choose file‚Ä¶
              <input id="lcFile" type="file" accept=".txt" style="display:none;">
            </label>
            <div id="lcFileName" class="muted" style="font-size:12px; margin-top:4px;"></div>
          </div>
          <div>
            <label for="target">Target name</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="target" name="target" placeholder="HAT-P-32 b" required style="flex:1 1 auto;" />
              <button type="button" id="infoCardBtn" class="btn"
                style="padding:6px 10px;font-size:11px;white-space:nowrap;" disabled>
                Planet info
              </button>
            </div>
          </div>

          <div>
            <label for="rank">Rank (NASA list)</label>
            <input id="rank" name="rank" type="number" min="1" placeholder="900" />
          </div>

          <div>
            <label for="depth">Rp¬≤/Rs¬≤ (depth)</label>
            <input id="depth" name="depth" type="number" step="0.0001" placeholder="0.0256" />
          </div>

          <div>
            <label for="depthErr">œÉ(Rp¬≤/Rs¬≤) (uncertainty)</label>
            <input id="depthErr" name="depthErr" type="number" step="0.0001" placeholder="0.0012" />
          </div>

          <div>
            <label for="snr">Transit SNR (œÉ)</label>
            <input id="snr" name="snr" type="number" step="0.1" placeholder="21.3" />
          </div>

          <div>
            <label for="obsDate">Observation date</label>
            <input id="obsDate" name="obsDate" type="date" />
          </div>

          <div>
            <label for="data">Data</label>
            <select id="data" name="data">
              <option value="">Select data type‚Ä¶</option>
              <option>EpW/MObs Checkout Data</option>
              <option>MObs Image Directory</option>
              <option>LCO</option>
              <option>Backyard Rig</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="muted" style="font-size:12px;margin-top:6px;">
          If both Rp¬≤/Rs¬≤ and œÉ(Rp¬≤/Rs¬≤) are provided, Transit SNR will be computed as depth / uncertainty.
        </div>

        <div class="template-row">
          <div>
            <label for="template">Template style</label>
            <select id="template" name="template">
              <option value="short">Short hype (Slack-style)</option>
              <option value="tech">Technical summary</option>
              <option value="minimal">Minimal (one-liner)</option>
            </select>
          </div>
        </div>

        <div class="flair-wrap">
          <div class="flair-heading">Automatic flair based on SNR &amp; rank:</div>

          <div class="flair-columns">
            <div class="flair-column">
              <div class="flair-title">SNR Flair</div>
              <div class="flair-rows">
                <div class="flair-row snr-tier" data-tier="20">
                  <span class="flair-label">SNR 20œÉ+ </span><span>üöÄ</span>
                </div>
                <div class="flair-row snr-tier" data-tier="10">
                  <span class="flair-label">SNR 10‚Äì19œÉ </span><span>‚ú®</span>
                </div>
                <div class="flair-row snr-tier" data-tier="5">
                  <span class="flair-label">SNR 5‚Äì9œÉ </span><span>üî≠</span>
                </div>
                <div class="flair-row snr-tier" data-tier="0">
                  <span class="flair-label">SNR 0‚Äì4œÉ </span><span>‚ö†Ô∏è</span>
                </div>
              </div>
            </div>

            <div class="flair-column">
              <div class="flair-title">Rank Flair</div>
              <div class="flair-rows">
                <div class="flair-row rank-tier" data-tier="100">
                  <span class="flair-label">Rank 1‚Äì100 </span><span>üëë</span>
                </div>
                <div class="flair-row rank-tier" data-tier="500">
                  <span class="flair-label">Rank 101‚Äì500 </span><span>üåõ</span>
                </div>
                <div class="flair-row rank-tier" data-tier="1000">
                  <span class="flair-label">Rank 501‚Äì1000 </span><span>üöÄ</span>
                </div>
                <div class="flair-row rank-tier" data-tier="1001">
                  <span class="flair-label">Rank 1001+ </span><span>üåå</span>
                </div>
              </div>
            </div>
          </div>

          <div id="autoFlair" class="flair-note">
            Enter SNR and/or rank to see which tier is active.
          </div>
        </div>

        <div class="inline-options" aria-label="Content options">
          <label><input type="checkbox" id="includeSNR" checked /> Include SNR line</label>
          <label><input type="checkbox" id="includeRank" checked /> Include rank</label>
          <label><input type="checkbox" id="includeData" checked /> Include Data</label>
          <label><input type="checkbox" id="includeFlair" checked /> Include flair emojis</label>
        </div>

        <div class="buttons-row">
          <button type="button" class="btn" id="generateBtn">Generate Post</button>
          <button type="button" class="btn" id="copyBtn">Copy to Clipboard</button>
          <button type="button" class="btn" id="saveBtn">Save to History</button>
          <button id="clearFormBtn" type="button" class="btn btn-secondary">Clear Form</button>
        </div>
      </form>
    </section>

    <!-- Output -->
    <section class="card" aria-labelledby="output-heading">
      <h2 id="output-heading">2. Generated Post</h2>
      <p class="muted">Preview of what you‚Äôll paste into Slack / Discord. Emojis are left as <code>:codes:</code>.</p>

      <textarea id="output" spellcheck="false"
        placeholder="Fill in the form above and click &quot;Generate Post&quot; to see the result."></textarea>

      <div style="margin-top:8px;font-size:12px;color:var(--muted);">
        Tip: tweak wording directly here if you want, then hit ‚ÄúSave to History‚Äù again to capture the edited version.
      </div>
    </section>

    <!-- History -->
    <section class="card" aria-labelledby="history-heading">
      <h2 id="history-heading">3. Local Observation History</h2>
      <p class="muted">
        Saved posts live in your browser only (via <code>localStorage</code>). Use this like a mini logbook of recent
        reductions.
      </p>

      <div id="historyEmpty" class="muted" style="font-size:13px;margin-top:6px;">
        No saved observations yet. Generate a post and click ‚ÄúSave to History‚Äù.
      </div>

      <div id="historyList" class="history-list" aria-live="polite"></div>
    </section>
  </main>

  <!-- Planet Info Card Dialog -->
  <dialog id="infoCardDialog">
    <form method="dialog" style="margin:0;max-width:420px;">
      <h2 id="infoCardTitle" style="margin-top:0;margin-bottom:8px;font-size:18px;">
        Planet Info
      </h2>

      <!-- NEW: badges row -->
      <div id="infoCardBadges" class="info-card-badges"></div>

      <p id="infoCardSummary" style="font-size:13px; color:var(--muted); margin-top:0;"></p>

      <!-- NEW: two-column layout -->
      <div class="info-card-grid">
        <div>
          <h3>Host star</h3>
          <ul id="infoCardStarDetails"></ul>
        </div>
        <div>
          <h3>Planet</h3>
          <ul id="infoCardPlanetDetails"></ul>
        </div>
      </div>

      <p id="infoCardLinkWrapper" style="margin:10px 0 14px;">
        <a id="infoCardNasaLink" href="#" target="_blank" rel="noopener"
          style="color:var(--link); font-size:13px; text-decoration:underline;">
          View full NASA page
        </a>
      </p>

      <div style="text-align:right;">
        <button type="submit" class="btn" style="font-size:12px; padding:6px 12px;">
          Close
        </button>
      </div>
    </form>
  </dialog>

  <footer>
    <p style="text-align:center; font-size:14px; color:var(--muted); margin:40px 0 20px;">
      ¬© <span id="y"></span> Exoplanet Slacker ‚Äî A community resource. <em>Not an official NASA site.</em>
    </p>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    const form = document.getElementById('transitForm');
    const outputEl = document.getElementById('output');
    const autoFlairEl = document.getElementById('autoFlair');
    const historyList = document.getElementById('historyList');
    const historyEmpty = document.getElementById('historyEmpty');

    const STORAGE_KEY = 'transitgenHistory_v1';
    /* ============================================================
   Planet Info Card (NASA Exoplanet Archive + dialog)
   ============================================================ */

    const infoCardBtn = document.getElementById('infoCardBtn');
    const infoCardDialog = document.getElementById('infoCardDialog');
    const infoCardTitle = document.getElementById('infoCardTitle');
    const infoCardSummary = document.getElementById('infoCardSummary');
    const infoCardBadges = document.getElementById('infoCardBadges');
    const infoCardStarDetails = document.getElementById('infoCardStarDetails');
    const infoCardPlanetDetails = document.getElementById('infoCardPlanetDetails');
    const infoCardNasaLink = document.getElementById('infoCardNasaLink');

    let currentPlanetInfo = null;
    let currentPlanetNasaUrl = null;
    let infoCardIsLoading = false;

    function syncInfoButtonState() {
      if (!infoCardBtn || !targetInput) return;
      const hasName = targetInput.value.trim().length > 0;

      if (infoCardIsLoading) {
        infoCardBtn.disabled = true;
        infoCardBtn.textContent = 'Loading‚Ä¶';
        infoCardBtn.title = 'Fetching planet data from NASA Exoplanet Archive‚Ä¶';
        return;
      }

      infoCardBtn.disabled = !hasName;
      infoCardBtn.textContent = 'Planet info';
      infoCardBtn.title = hasName
        ? 'Fetch planet info for this target'
        : 'Enter a target name first';
    }

    function buildNasaExoplanetUrl(plName) {
      if (!plName) return null;
      const slug = plName
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '-'); // spaces ‚Üí hyphens
      return `https://science.nasa.gov/exoplanet-catalog/${slug}/`;
    }

    async function fetchPlanetInfo(plName) {
      const url =
        "https://lost-matrix-relics.vercel.app/api/planet-info?name=" +
        encodeURIComponent(plName);

      const res = await fetch(url);
      if (!res.ok) return null;
      return await res.json();
    }

    function classifyStar(stTeff, stSpectype) {
      if (!stTeff && !stSpectype) return null;

      // If we have a spectral type string, trust its first letter
      if (stSpectype && stSpectype.trim().length > 0) {
        const letter = stSpectype.trim()[0].toUpperCase();
        if ("OBAFGKM".includes(letter)) {
          return `${letter}-type star`;
        }
      }

      if (!stTeff) return null;

      const teff = Number(stTeff);
      if (Number.isNaN(teff)) return null;

      if (teff >= 7500) return "A-type star";
      if (teff >= 6000) return "F-type star";
      if (teff >= 5200) return "G-type star";
      if (teff >= 3700) return "K-type star";
      if (teff >= 2400) return "M-type star";
      return "cool star";
    }

    function classifyPlanet(plRade, plBmasse, plEqt) {
      const r = plRade != null ? Number(plRade) : null;
      const t = plEqt != null ? Number(plEqt) : null;

      let sizeClass = "";
      if (r && !Number.isNaN(r)) {
        if (r < 1.5) sizeClass = "Earth-size planet";
        else if (r < 2.5) sizeClass = "super-Earth";
        else if (r < 4) sizeClass = "sub-Neptune";
        else if (r < 8) sizeClass = "Neptune-size planet";
        else sizeClass = "gas giant";
      }

      let tempClass = "";
      if (t && !Number.isNaN(t)) {
        if (t >= 1800) tempClass = "ultra-hot";
        else if (t >= 1000) tempClass = "hot";
        else if (t >= 500) tempClass = "warm";
        else tempClass = "temperate/cool";
      }

      if (!sizeClass && !tempClass) return null;
      if (sizeClass && tempClass) {
        return `${tempClass} ${sizeClass}`; // e.g., "hot gas giant"
      }
      return sizeClass || tempClass;
    }

    function addInfoBadge(text, extraClass) {
      if (!infoCardBadges) return;
      const span = document.createElement("span");
      span.textContent = text;
      span.className = "info-card-badge" + (extraClass ? " " + extraClass : "");
      infoCardBadges.appendChild(span);
    }

    function populateInfoCard(info, nasaUrl) {
      if (!infoCardDialog) return;

      const {
        pl_name,
        hostname,
        pl_rade,
        pl_bmasse,
        pl_orbper,
        pl_eqt,
        disc_year,
        discoverymethod,
        st_spectype,
        st_teff,
        st_rad,
        st_dist,
      } = info;

      // Title
      infoCardTitle.textContent = pl_name || "Planet info";

      // Classifications
      const starClass = classifyStar(st_teff, st_spectype);
      const planetClass = classifyPlanet(pl_rade, pl_bmasse, pl_eqt);

      // Summary line
      const methodPart = discoverymethod
        ? discoverymethod.toLowerCase() + "-discovered exoplanet"
        : "exoplanet";

      const hostPart = hostname ? ` around ${hostname}` : "";
      const yearPart = disc_year ? `, discovered in ${disc_year}` : "";

      infoCardSummary.textContent =
        `${pl_name || "This planet"} is a ${methodPart}${hostPart}${yearPart}.`;

      // Badges row
      if (infoCardBadges) {
        infoCardBadges.innerHTML = "";
        if (planetClass) addInfoBadge(`Planet: ${planetClass}`, "badge-planet");
        if (starClass) addInfoBadge(`Star: ${starClass}`, "badge-star");
      }

      // Clear both detail columns
      if (infoCardStarDetails) infoCardStarDetails.innerHTML = "";
      if (infoCardPlanetDetails) infoCardPlanetDetails.innerHTML = "";

      // Host star column
      const starDetails = [];
      if (starClass) starDetails.push(`Classification: ${starClass}`);
      if (st_spectype) starDetails.push(`Spectral type: ${st_spectype}`);
      if (st_teff != null)
        starDetails.push(`Effective temp: ${Math.round(Number(st_teff))} K`);
      if (st_rad != null)
        starDetails.push(`Radius: ${Number(st_rad).toFixed(2)} Solar radii`);
      if (st_dist != null) {
        const pc = Number(st_dist);
        const ly = pc * 3.26156;
        starDetails.push(
          `Distance: ${pc.toFixed(1)} pc (${ly.toFixed(1)} ly)`
        );
      }

      starDetails.forEach((text) => {
        const li = document.createElement("li");
        li.textContent = text;
        infoCardStarDetails.appendChild(li);
      });

      // Planet column
      const planetDetails = [];
      if (planetClass) planetDetails.push(`Classification: ${planetClass}`);
      if (pl_orbper != null)
        planetDetails.push(
          `Orbital period: ${Number(pl_orbper).toFixed(2)} days`
        );
      if (pl_rade != null)
        planetDetails.push(`Radius: ${Number(pl_rade).toFixed(2)} Earth radii`);
      if (pl_bmasse != null)
        planetDetails.push(`Mass: ${Number(pl_bmasse).toFixed(1)} Earth masses`);
      if (pl_eqt != null)
        planetDetails.push(
          `Equilibrium temp: ${Math.round(Number(pl_eqt))} K`
        );

      planetDetails.forEach((text) => {
        const li = document.createElement("li");
        li.textContent = text;
        infoCardPlanetDetails.appendChild(li);
      });

      // NASA link
      if (nasaUrl) {
        infoCardNasaLink.href = nasaUrl;
        infoCardNasaLink.parentElement.style.display = "";
      } else {
        infoCardNasaLink.href = "#";
        infoCardNasaLink.parentElement.style.display = "none";
      }
    }

    async function updateInfoCardFromTarget(rawName) {
      if (!infoCardBtn) return;

      currentPlanetInfo = null;
      currentPlanetNasaUrl = null;

      const name = (rawName || '').trim();

      // reset button
      infoCardBtn.disabled = true;
      infoCardBtn.textContent = 'Planet info';
      infoCardBtn.title = '';

      if (!name) return;

      infoCardIsLoading = true;
      infoCardBtn.textContent = 'Loading‚Ä¶';
      infoCardBtn.title = 'Fetching planet data from NASA Exoplanet Archive‚Ä¶';

      try {
        const info = await fetchPlanetInfo(name);

        if (!info) {
          infoCardBtn.disabled = true;
          infoCardBtn.textContent = 'No info found';
          infoCardBtn.title = `No entry found in NASA Exoplanet Archive for "${name}".`;
          return;
        }

        currentPlanetInfo = info;
        currentPlanetNasaUrl = buildNasaExoplanetUrl(info.pl_name || name);

        infoCardBtn.disabled = false;
        infoCardBtn.textContent = 'Planet info';
        infoCardBtn.title = 'Show planet info card';
      } catch (err) {
        console.error('Planet info fetch failed:', err);

        // Show a clear error state
        infoCardBtn.disabled = true;
        infoCardBtn.textContent = 'Info unavailable';
        infoCardBtn.title = 'Could not load planet info (check console for details).';
      } finally {
        infoCardIsLoading = false;
      }
    }

    /* ============================================================
       = Rank Lookup (Flexible / Canonical Matching) =
       ============================================================ */

    let rankLookup = {};            // exact names from JSON (lowercase)
    let rankLookupCanonical = {};   // "stripped" names (no spaces/hyphens/punctuation)

    function canonicalName(name) {
      if (!name) return "";
      return name
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "");   // remove everything except a‚Äìz and 0‚Äì9
    }

    async function loadRankLookup() {
      try {
        // If you put it in /data/, change to 'data/epw_ranks_pretty.json'
        const res = await fetch('epw_ranks_pretty.json');
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();

        // data is canonicalKey -> { name, rank }
        rankLookup = {};              // not really used anymore, but keep it defined
        rankLookupCanonical = data;   // use canonical map directly

      } catch (err) {
        console.warn("Rank lookup failed:", err);
        rankLookup = {};
        rankLookupCanonical = {};
      }
    }

    function findRankForTarget(name) {
      if (!name) return null;
      const c = canonicalName(name);
      return rankLookupCanonical[c] ?? null;   // { name, rank } or null
    }

    /* ============================================================ */

    function formatDateHuman(value) {
      if (!value) return '';
      const d = new Date(value + 'T00:00:00');
      if (isNaN(d.getTime())) return '';
      const day = String(d.getDate()).padStart(2, '0');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const mon = monthNames[d.getMonth()];
      const year = d.getFullYear();
      return `${day}-${mon}-${year}`;
    }

    function snrFlair(snr) {
      if (snr === '' || snr === null || snr === undefined) return '';
      const s = Number(snr);
      if (!isFinite(s)) return '';
      if (s >= 20) return ':rocket:';
      if (s >= 10) return ':sparkles:';
      if (s >= 5) return ':telescope:';
      if (s > 0) return ':warning:';
      return '';
    }

    function rankFlair(rank) {
      if (rank === '' || rank === null || rank === undefined) return '';
      const r = Number(rank);
      if (!isFinite(r)) return '';
      if (r <= 100) return ':crown:';
      if (r <= 500) return ':first_quarter_moon_with_face:';
      if (r <= 1000) return ':rocket:';
      return ':milky_way:';
    }

    function updateAutoFlair() {
      const snrStr = document.getElementById('snr').value.trim();
      const rankStr = document.getElementById('rank').value.trim();

      const snr = snrStr === '' ? NaN : Number(snrStr);
      const rank = rankStr === '' ? NaN : Number(rankStr);

      const snrText = snrStr ? `SNR ${snrStr}œÉ ‚Üí ${snrFlair(snrStr) || 'no flair'}` : '';
      const rankText = rankStr ? `Rank ${rankStr} ‚Üí ${rankFlair(rankStr) || 'no flair'}` : '';

      const bits = [];
      if (snrText) bits.push(snrText);
      if (rankText) bits.push(rankText);

      if (bits.length) {
        autoFlairEl.textContent = bits.join(' | ');
      } else {
        autoFlairEl.textContent = 'Enter SNR and/or rank to see which tier is active.';
      }

      // clear previous highlights
      document.querySelectorAll('.snr-tier').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.rank-tier').forEach(el => el.classList.remove('active'));

      // SNR highlight
      if (!isNaN(snr)) {
        let selector = null;
        if (snr >= 20) selector = '.snr-tier[data-tier="20"]';
        else if (snr >= 10) selector = '.snr-tier[data-tier="10"]';
        else if (snr >= 5) selector = '.snr-tier[data-tier="5"]';
        else if (snr >= 0) selector = '.snr-tier[data-tier="0"]';
        if (selector) {
          const el = document.querySelector(selector);
          if (el) el.classList.add('active');
        }
      }

      // Rank highlight
      if (!isNaN(rank)) {
        let selector = null;
        if (rank <= 100) selector = '.rank-tier[data-tier="100"]';
        else if (rank <= 500) selector = '.rank-tier[data-tier="500"]';
        else if (rank <= 1000) selector = '.rank-tier[data-tier="1000"]';
        else if (rank > 1000) selector = '.rank-tier[data-tier="1001"]';
        if (selector) {
          const el = document.querySelector(selector);
          if (el) el.classList.add('active');
        }
      }
    }

    function updateSNRFromDepth() {
      const depthVal = document.getElementById('depth').value.trim();
      const depthErrVal = document.getElementById('depthErr').value.trim();
      if (!depthVal || !depthErrVal) {
        return;
      }
      let depth = Number(depthVal);
      let depthErr = Number(depthErrVal);
      const snrField = document.getElementById('snr');

      if (!isFinite(depth) || !isFinite(depthErr) || depthErr <= 0) {
        return;
      }

      try {
        const snr = depth / depthErr;
        if (!isFinite(snr)) return;
        snrField.value = snr.toFixed(1);
        updateAutoFlair();
      } catch (e) { }
    }

    /* ===========================================
       = NEW: Auto-fill Rank when Target changes =
       =========================================== */

    const targetInput = document.getElementById('target');
    const rankInput = document.getElementById('rank');
    const lcFileInput = document.getElementById('lcFile');
    const lcFileNameEl = document.getElementById('lcFileName');

    // Button click opens dialog if we have data
    if (infoCardBtn && infoCardDialog) {
      infoCardBtn.addEventListener('click', async () => {
        const name = (targetInput.value || '').trim();
        if (!name) return;

        infoCardIsLoading = true;
        syncInfoButtonState();

        try {
          const info = await fetchPlanetInfo(name);

          if (!info) {
            infoCardIsLoading = false;
            infoCardBtn.disabled = false;
            infoCardBtn.textContent = 'No info found';
            infoCardBtn.title = `No entry found in NASA Exoplanet Archive for "${name}".`;
            return;
          }

          currentPlanetInfo = info;
          currentPlanetNasaUrl = buildNasaExoplanetUrl(info.pl_name || name);

          // Populate and show the dialog immediately on first click
          populateInfoCard(currentPlanetInfo, currentPlanetNasaUrl);
          infoCardDialog.showModal();
        } catch (err) {
          console.error('Planet info fetch failed:', err);
          infoCardBtn.textContent = 'Info unavailable';
          infoCardBtn.title = 'Could not load planet info (check console for details).';
        } finally {
          infoCardIsLoading = false;
          syncInfoButtonState();
        }
      });
    }

    if (lcFileInput) {
      lcFileInput.addEventListener('change', handleLcFileImport);
    }

    function tryAutoFillRank() {
      const rawName = targetInput.value;

      // If user already typed a rank manually, just refresh the button state
      if (rankInput.value.trim()) {
        syncInfoButtonState();
        return;
      }

      const entry = findRankForTarget(rawName);  // { name, rank }

      if (entry != null) {
        // pretty name + rank from JSON
        targetInput.value = entry.name;          // e.g. "HAT-P-32 b"
        rankInput.value = entry.rank;            // e.g. 900
        updateAutoFlair();
      } else if (rawName.trim() !== "") {
        autoFlairEl.textContent =
          "Target not found ‚Äî check spelling, catalog, or formatting.";
      }

      // Just update button enabled/disabled state ‚Äî no auto fetch
      syncInfoButtonState();
    }

    targetInput.addEventListener('blur', tryAutoFillRank);
    targetInput.addEventListener('change', tryAutoFillRank);
    

    /* =========================================== */


    function buildPost() {
      const target = document.getElementById('target').value.trim();
      const rank = document.getElementById('rank').value.trim();
      const snr = document.getElementById('snr').value.trim();
      const obsDate = document.getElementById('obsDate').value;
      const data = document.getElementById('data').value;
      const includeSNR = document.getElementById('includeSNR').checked;
      const includeRank = document.getElementById('includeRank').checked;
      const includeFlair = document.getElementById('includeFlair').checked;
      const includeData = document.getElementById('includeData').checked;
      const template = document.getElementById('template').value;

      if (!target) {
        outputEl.value = 'Please enter at least a target name.';
        return '';
      }

      const humanDate = formatDateHuman(obsDate);
      // Only add emojis if flair is enabled
      let snrEmoji = '';
      let rankEmoji = '';
      if (includeFlair) {
        snrEmoji = snrFlair(snr);
        rankEmoji = rankFlair(rank);
      }

      let lines = [];

      if (template === 'short') {
        let line1 = target;
        if (includeRank && rank) {
          line1 += ` (rank ${rank})`;
        }
        if (includeRank && rankEmoji) {
          line1 += ` ${rankEmoji}`;
        }
        lines.push(line1);

        if (includeSNR && snr) {
          let line2 = `${snr}œÉ SNR`;
          if (snrEmoji) line2 += ` ${snrEmoji}`;
          lines.push(line2);
        }

        let parts = [];
        if (humanDate) parts.push(humanDate);
        if (includeData && data) parts.push(data);
        const line3 = parts.join(', ');
        if (line3) lines.push(line3);

      } else if (template === 'tech') {
        let header = target;
        if (includeRank && rank) {
          header += ` | rank ${rank}`;
          if (rankEmoji) header += ` ${rankEmoji}`;
        }
        if (includeSNR && snr) {
          header += ` | SNR ${snr}œÉ`;
          if (snrEmoji) header += ` ${snrEmoji}`;
        }
        lines.push(header);

        let meta = [];
        if (humanDate) meta.push(humanDate);
        if (includeData && data) meta.push(data);
        if (meta.length) lines.push(meta.join(' ‚Äî '));

      } else if (template === 'minimal') {
        let line = target;
        if (includeRank && rank) {
          line += ` (rank ${rank}`;
          if (rankEmoji) line += ` ${rankEmoji}`;
          line += ')';
        }
        if (includeSNR && snr) {
          line += ` ‚Äî ${snr}œÉ SNR`;
          if (snrEmoji) line += ` ${snrEmoji}`;
        }
        if (humanDate) line += ` ‚Äî ${humanDate}`;
        if (includeData && data) line += ` ‚Äî ${data}`;
        lines.push(line);
      }

      const post = lines.join('\n');
      outputEl.value = post;
      return post;
    }

    function copyToClipboard() {
      const text = outputEl.value;
      if (!text.trim()) return;
      navigator.clipboard?.writeText(text).then(() => {
        const original = document.getElementById('copyBtn').textContent;
        document.getElementById('copyBtn').textContent = 'Copied!';
        setTimeout(() => { document.getElementById('copyBtn').textContent = original; }, 1000);
      }).catch(() => { });
    }

    function loadHistory() {
      let items = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) items = JSON.parse(raw);
      } catch (e) { }
      renderHistory(items);
    }

    function renderHistory(items) {
      historyList.innerHTML = '';
      if (!items || !items.length) {
        historyEmpty.style.display = 'block';
        return;
      }
      historyEmpty.style.display = 'none';
      items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'history-item';

        const header = document.createElement('div');
        header.className = 'history-header';
        header.innerHTML = `<span>${item.target || 'Unknown target'}</span><span class="history-meta">${item.date || ''}</span>`;
        div.appendChild(header);

        const meta = document.createElement('div');
        let metaBits = [];
        if (item.rank) metaBits.push(`rank ${item.rank}`);
        if (item.snr) metaBits.push(`SNR ${item.snr}œÉ`);
        if (item.template) metaBits.push(item.template);
        meta.textContent = metaBits.join(' ‚Ä¢ ');
        meta.className = 'history-meta';
        div.appendChild(meta);

        const preview = document.createElement('div');
        preview.style.marginTop = '4px';
        preview.style.whiteSpace = 'pre-wrap';
        preview.style.fontSize = '12px';
        preview.textContent = item.post;
        div.appendChild(preview);

        const actions = document.createElement('div');
        actions.className = 'history-actions';

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'mini-btn';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', () => navigator.clipboard?.writeText(item.post || ''));

        const loadBtn = document.createElement('button');
        loadBtn.type = 'button';
        loadBtn.className = 'mini-btn';
        loadBtn.textContent = 'Load into editor';
        loadBtn.addEventListener('click', () => { outputEl.value = item.post || ''; });

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'mini-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => {
          let arr = [];
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) arr = JSON.parse(raw);
          } catch (e) { }
          arr.splice(idx, 1);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
          renderHistory(arr);
        });

        actions.appendChild(copyBtn);
        actions.appendChild(loadBtn);
        actions.appendChild(deleteBtn);
        div.appendChild(actions);

        historyList.appendChild(div);
      });
    }

    function saveToHistory() {
      // Prefer whatever is currently in the output box (including manual edits)
      let post = (outputEl.value || '').trim();

      // If the user hasn't generated/edited anything yet, build a fresh post
      if (!post) {
        post = buildPost();
      }

      if (!post || !post.trim()) return;

      const target = document.getElementById('target').value.trim();
      const rank = document.getElementById('rank').value.trim();
      const snr = document.getElementById('snr').value.trim();
      const obsDate = document.getElementById('obsDate').value;
      const template = document.getElementById('template').value;

      let items = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) items = JSON.parse(raw);
      } catch (e) { }

      const entry = {
        target,
        rank,
        snr,
        date: formatDateHuman(obsDate),
        template,
        post,
      };

      items.unshift(entry);
      if (items.length > 30) items = items.slice(0, 30);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      renderHistory(items);
    }

    function handleLcFileImport(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      if (lcFileNameEl) {
        lcFileNameEl.textContent = file.name;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const meta = parseExoticText(text, file.name);

        if (!meta) {
          autoFlairEl.textContent = "Could not read metadata from file. Check format.";
          return;
        }

        let changed = false;

        if (meta.target) {
          targetInput.value = meta.target;
          // this will also pretty-format and rank-fill from your JSON
          tryAutoFillRank();
          changed = true;
        }

        if (meta.snr) {
          document.getElementById('snr').value = meta.snr;
          changed = true;
        }

        if (meta.depth) {
          document.getElementById('depth').value = meta.depth;
          changed = true;
        }

        if (meta.depthErr) {
          document.getElementById('depthErr').value = meta.depthErr;
          changed = true;
        }

        if (meta.date) {
          document.getElementById('obsDate').value = meta.date; // YYYY-MM-DD
          changed = true;
        }

        if (meta.data) {
          const dataSelect = document.getElementById('data');
          if (dataSelect) {
            dataSelect.value = meta.data; // e.g. "EpW/MObs Checkout Data"
          }
        }

                if (changed) {
          updateAutoFlair();
        }
      };

      reader.readAsText(file);
    }

    /**
     * Parse EXOTIC / AAVSO metadata .txt created alongside the lightcurve.
     * Returns an object like:
     * { target, depth, depthErr, snr, date, data } or null if nothing usable found.
     */
    function parseExoticText(text, fileName) {
      if (!text) return null;

      const lines = text.split(/\r?\n/);
      const meta = {};

      for (const raw of lines) {
        const line = raw.trim();
        if (!line || !line.startsWith('#')) continue;

        // Target name (prefer exoplanet name, fall back to star name)
        if (line.startsWith('#EXOPLANET_NAME=')) {
          meta.target = line.split('=')[1].trim();
        } else if (line.startsWith('#STAR_NAME=') && !meta.target) {
          meta.target = line.split('=')[1].trim();
        }

        // Data source / instrument hint
        if (line.startsWith('#SECONDARY_OBSCODES=') || line.startsWith('#OBSCODE=')) {
          const v = line.split('=')[1].trim().toUpperCase();
          if (v.includes('MOBS')) {
            meta.data = 'EpW/MObs Checkout Data';
          } else if (v.includes('LCO')) {
            meta.data = 'LCO';
          } else {
            // leave it undefined; user can pick "Backyard Rig" or "Other"
          }
        }

        // Rp/R* and its uncertainty from RESULTS line
        if (line.startsWith('#RESULTS=')) {
          // Example: #RESULTS=..., Rp/R*=0.134 +/- 0.014, ...
          const m = line.match(/Rp\/R\*=\s*([0-9.]+)\s*\+\/-\s*([0-9.]+)/);
          if (m) {
            const rp = parseFloat(m[1]);
            const rpErr = parseFloat(m[2]);
            if (Number.isFinite(rp) && Number.isFinite(rpErr) && rp > 0 && rpErr > 0) {
              const depth = rp * rp;
              const depthErr = 2 * rp * rpErr; // error propagation for x^2

              meta.depth = depth.toFixed(4);      // Rp^2/Rs^2
              meta.depthErr = depthErr.toFixed(4);

              if (depthErr > 0) {
                const snr = depth / depthErr;
                if (Number.isFinite(snr)) {
                  meta.snr = snr.toFixed(1);
                }
              }
            }
          }
        }
      }

      // Observation date from filename, e.g. AAVSO_WASP-12 b_2025-11-21.txt
      if (fileName && !meta.date) {
        // 1) Try YYYY-MM-DD (standard EXOTIC)
        let m = fileName.match(/\d{4}-\d{2}-\d{2}/);
        if (m) {
          meta.date = m[0]; // already YYYY-MM-DD
        } else {
          // 2) Try DD-MMM-YYYY (local EXOTIC)
          m = fileName.match(/(\d{2})-([A-Za-z]{3})-(\d{4})/);
          if (m) {
            const [, dd, monStr, yyyy] = m;
            const monthMap = {
              JAN: '01',
              FEB: '02',
              MAR: '03',
              APR: '04',
              MAY: '05',
              JUN: '06',
              JUL: '07',
              AUG: '08',
              SEP: '09',
              OCT: '10',
              NOV: '11',
              DEC: '12',
            };
            const mm = monthMap[monStr.toUpperCase()];
            if (mm) {
              meta.date = `${yyyy}-${mm}-${dd}`;
            }
          }
        }
      }

      if (!meta.target && !meta.snr && !meta.depth && !meta.depthErr && !meta.date && !meta.data) {
        return null;
      }

      return meta;
    }

    function clearForm() {
      // Clear all inputs
      form.reset();

      // Clear dynamic fields
      document.getElementById('rank').value = '';
      document.getElementById('snr').value = '';
      document.getElementById('depth').value = '';
      document.getElementById('depthErr').value = '';
      document.getElementById('obsDate').value = '';
      document.getElementById('lcFileName').textContent = '';

      // Reset auto flair preview
      autoFlairEl.textContent = 'Enter SNR and/or rank to see suggested flair.';

      // Remove highlight classes
      document.querySelectorAll('.flair-row.active').forEach(el => {
        el.classList.remove('active');
      });

      // Clear output box
      outputEl.value = '';

      // Re-run initial UI updates
      updateAutoFlair();
    }

    document.getElementById('generateBtn').addEventListener('click', buildPost);
    document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
    document.getElementById('saveBtn').addEventListener('click', saveToHistory);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);

    ['snr', 'rank'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateAutoFlair);
    });

    document.getElementById('depth').addEventListener('input', updateSNRFromDepth);
    document.getElementById('depthErr').addEventListener('input', updateSNRFromDepth);

    updateAutoFlair();
    loadHistory();
    loadRankLookup();
    syncInfoButtonState();
  </script>
</body>

</html>